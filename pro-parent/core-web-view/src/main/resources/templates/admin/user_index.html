<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/common/common_head_css::commonHeader">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>用户信息</title>
    <meta name="description" content="overview &amp; stats" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
</head>
<body class="no-skin">
    <div class="main-container" id="main-container">
        <script type="text/javascript">
            try{ace.settings.check('main-container' , 'fixed')}catch(e){}
        </script>

        <div id="layout" class="easyui-layout">
            <div data-options="region:'west'" style="width:200px;">
                <div id="accordion" class="easyui-accordion">
                    <div title="组织部门" data-options="selected:true,collapsible:false" style="overflow:auto;padding:10px;">
                        <ul id="orgTree" class="easyui-tree"></ul>
                    </div>
                </div>
            </div>
            <div data-options="region:'center',title:'系统用户列表'" style="overflow:hidden;padding:5px">
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <div class="widget-box">
                            <div class="widget-header widget-header-small">
                                <h5 class="widget-title lighter">筛选</h5>
                            </div>
                            <div class="widget-body">
                                <div class="widget-main">
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-8">
                                            <div class="input-group">
                                                <span class="input-group-addon">
                                                    <i class="ace-icon fa fa-check"></i>
                                                </span>
                                                <input type="text" id="name" name="name" class="form-control search-query" placeholder="请输入关键字" />
                                                <span class="input-group-btn">
                                                    <button type="button" id="btn_search" onclick="filterTable()" class="btn btn-purple btn-sm">
                                                        <span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
                                                        搜索
                                                    </button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row-fluid" style="margin-bottom: 5px;">
                            <div class="span12 control-group" id="permissionBtns">
                                <!--权限按钮-->
                            </div>
                        </div>
                    </div><!-- /.col -->
                </div><!-- /.row -->
                <table id="grid-table"></table>
            </div>
        </div>

    </div><!-- /.main-container -->

    <!--导入通用js-->
    <div th:include="/common/common_head_js::onLoadJS"></div>
    <script th:src="@{/easyui/easyloader.js}"></script>
    <!--引入自定义本地存储对象myStorage，它依赖于cookieStorage.js-->
    <script th:src="@{/script/cookieStorage.js}"></script>
    <script th:src="@{/script/myStorage.js}"></script>

    <script type="text/javascript">
        var base = 'http://localhost:8080';
        easyloader.base = "/easyui/";
        easyloader.locales = 'zh_CN';
        easyloader.theme = 'bootstrap';
        easyloader.load(['layout','accordion','datagrid','tree'],function(){

            // 初始化 easyui 组件
            $('#layout').layout({
                fit:true
            });

            $('#accordion').accordion({
                animate:true,
                multiple:false,
                fit:true,
                border:false,
            });

            // 初始化表格
            $('#grid-table').datagrid({
                striped : true,
                idField:'id',
                loadMsg: "加载中......",
                method:'get',
                fit:true,
                fitColumns:true,
                autoRowHeight:false,
                singleSelect:true,
                pagination:true,
                pageSize : 20,
                pageList : [ 10, 20, 30, 40, 50, 100, 200, 300, 400, 500 ],
                columns:[[
                    {title:'账号',field:'loginName',width:100,align:'center'},
                    {title:'姓名',field:'realName',width:100,align:'center'},
                    {title:'性别',field:'genderDesc',width:80,align:'center'},
                    {title:'所在部门',field:'organizationName',width:100,align:'center'},
                    {title:'账号状态',field:'statesMsg',width:80,align:'center'}
                ]]
            });
            loadGrid();

            // 初始化tree
            $('#orgTree').tree({
                onClick: function(node){
                    loadGrid(node.id);
                },
                loadFilter:dataLoad
            });

            // 加载组织部门树
            var promise = $.ajax({
                url:base + '/orgs/tree',
                dataType:'json',
                type:'get',
                headers:{"Authorization":JSON.parse( myStorage.getItem('currentUser')).token,"Content-Type":"application/json;charset=UTF-8"}
            });
            promise.done(function (data) {
                $('#orgTree').tree('loadData',data);
            }).fail(function (error) {
                layer.msg(error.responseJSON.msg);
            });

            // 初始化权限按钮
            var promise1 = $.ajax({
                url:base + '/resources/userRes/' + JSON.parse( myStorage.getItem('currentUser')).name,
                dataType:'json',
                type:'get',
                headers:{"Authorization":JSON.parse( myStorage.getItem('currentUser')).token,"Content-Type":"application/json;charset=UTF-8"}
            });
            promise1.done(function (data) {
                var res = data.data;
                if(isInArray(res,'/admin/user/add')){
                    $('#permissionBtns').append('<button class="btn btn-primary" onclick="addUser()" id="btn-add">添加</button>');
                }
                if(isInArray(res,'/admin/user/edit')){
                    $('#permissionBtns').append('<button class="btn btn-info" onclick="modifyUser()" id="btn-edit">编辑</button>');
                }
            }).fail(function (error) {
                layer.msg(error.responseJSON.msg);
            })
        });

        // 递归过滤标准树形树形，添加一个 text 属性，值就是name属性的值
        function dataLoad(data,parent) {
            data.forEach(function (obj,index) {
                obj.text = obj.orgName;

                childLoad(obj);
            })

            return data;
        }
        function childLoad(obj) {
            if(obj.children !== null && obj.children.length > 0){
                obj.children.forEach(function (obj, index) {
                    obj.text = obj.orgName;
                    childLoad(obj);
                })
            }
        }

        // 表格过滤
        function filterTable(e){
            var name = $("#name").val();
            if(!name.isEmpty()){
                loadGrid(undefined,name);
            }
        }

        // 加载表格
        function loadGrid(orgId,loginName){
            var page = $("#grid-table").datagrid("getPager");
            var pageOptions = $(page).pagination('options');
            var baseUrl = base + '/users/page?page=' + pageOptions.pageNumber + '&rows=' + pageOptions.pageSize;
            if (orgId){
                baseUrl += '&orgId=' + orgId;
            }
            if(loginName){
                baseUrl += '&loginName=' + loginName;
            }
            var promise = $.ajax({
                url : baseUrl,
                dataType:'json',
                type:'get',
                headers:{"Authorization":JSON.parse( myStorage.getItem('currentUser')).token,"Content-Type":"application/json;charset=UTF-8"}
            });
            promise.done(function (data) {
                $('#grid-table').datagrid('loadData',data);
            }).fail(function (error) {
                layer.msg(error.responseJSON.msg);
            });
        }

        function addUser(){
            layer.open({
                type: 2,
                fix: false,
                title: '添加用户',
                maxmin: true,
                content: '/admin/user/add',
                area: ['770px', '500px']
            });
        }

        function modifyUser() {
            var row = selectRow();
            if (row === null) {
                layer.msg("请选择要修改的用户数据行");
                return;
            }
            layer.open({
                type: 2,
                fix: false,
                title: '用户修改',
                maxmin: true,
                content: '/admin/user/edit/'+row.id,
                area: ['770px', '500px']
            });
        }

        // 判断 url 是否在指定数组中
        function isInArray(resArray,val){
            for (var k=0;k<resArray.length;k++) {
                if(val === resArray[k].url){
                    return true;
                }
            }
            return false;
        }
        //重新加载表格
        function reloadGrid(){
            $('#grid-table').datagrid('load');
        }
        //选中表格的一行
        function selectRow(){
            return $('#grid-table').datagrid('getSelected');
        }
    </script>
</body>
</html>