<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/common/common_head_css::commonHeader">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8"/>
    <title>组织部门信息</title>
    <meta name="description" content="overview &amp; stats"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
</head>
<body class="no-skin">
    <div class="main-container" id="main-container">
        <script type="text/javascript">
            try {
                ace.settings.check('main-container', 'fixed')
            } catch (e) {
            }
        </script>

        <div class="main-content" id="page-wrapper">
            <div class="page-content" id="page-content">
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                    </div>
                    <div class="col-xs-12">
                        <div class="row-fluid" style="margin-bottom: 5px;">
                            <div class="span12 control-group" id="permissionBtns">
                                <!--权限菜单-->
                            </div>
                        </div>
                        <!-- PAGE CONTENT BEGINS -->
                        <table id="grid-table"></table>
                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div>
        </div>
    </div><!-- /.main-container -->

    <!--导入通用js-->
    <div th:include="/common/common_head_js::onLoadJS"></div>
    <script th:src="@{/easyui/easyloader.js}"></script>
    <!--引入自定义本地存储对象myStorage，它依赖于cookieStorage.js-->
    <script th:src="@{/script/cookieStorage.js}"></script>
    <script th:src="@{/script/myStorage.js}"></script>

    <script type="text/javascript">
        var base = 'http://localhost:8080';
        easyloader.base = "/easyui/";
        easyloader.locales = 'zh_CN';
        easyloader.theme = 'bootstrap';
        easyloader.load('treegrid', function () {

            $('#grid-table').treegrid({
                idField: 'id',
                treeField: 'orgName',
                loadMsg: "加载中......",
                fit: false,
                fitColumns: true,
                autoRowHeight: false,
                animate: true,
                columns: [[
                    {title: '组织部门名称', field: 'orgName', width: 120, align: 'center'},
                    {title: '组织部门描述', field: 'orgBak', width: 300, align: 'center'},
                ]]
            });

            // 加载表格数据
            var promise = $.ajax({
                url:base + '/orgs/tree',
                dataType:'json',
                type:'get',
                headers:{"Authorization":JSON.parse( myStorage.getItem('currentUser')).token,"Content-Type":"application/json;charset=UTF-8"}
            });
            promise.done(function (data) {
                $('#grid-table').treegrid('loadData',data);
            }).fail(function (error) {
                console.log(error);
            });

            // 初始化权限按钮
            var promise1 = $.ajax({
                url: base + '/resources/userRes/' + JSON.parse(myStorage.getItem('currentUser')).name,
                dataType: 'json',
                type: 'get',
                headers: {
                    "Authorization": JSON.parse(myStorage.getItem('currentUser')).token,
                    "Content-Type": "application/json;charset=UTF-8"
                }
            });
            promise1.done(function (data) {
                var res = data.data;
                if (isInArray(res, '/admin/org/add')) {
                    $('#permissionBtns').append('<button class="btn btn-primary" onclick="addOrg()" id="btn-add">添加</button>');
                }
                if (isInArray(res, '/admin/org/edit')) {
                    $('#permissionBtns').append('<button class="btn btn-info" onclick="modifyOrg()" id="btn-edit">编辑</button>');
                }
            }).fail(function (error) {
                layer.msg(error.responseJSON.msg);
            })
        });

        function addOrg() {
            layer.open({
                type: 2,
                fix: false,
                title: '添加组织部门',
                maxmin: true,
                content: '/admin/org/add',
                area: ['770px', '450px']
            });
        }

        function modifyOrg() {
            var row = selectRow();
            if (row === null) {
                layer.msg("请选择要修改的组织部门数据行");
                return;
            }
            layer.open({
                type: 2,
                fix: false,
                title: '数据组织部门',
                maxmin: true,
                content: '/admin/org/edit/' + row.id,
                area: ['770px', '450px']
            });
        }

        // 判断 url 是否在指定数组中
        function isInArray(resArray, val) {
            for (var k = 0; k < resArray.length; k++) {
                if (val === resArray[k].url) {
                    return true;
                }
            }
            return false;
        }

        //重新加载表格
        function reloadGrid() {
            $('#grid-table').treegrid('load');
        }

        //选中表格的一行
        function selectRow() {
            return $('#grid-table').treegrid('getSelected');
        }
    </script>
</body>
</html>