<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.startcaft.basic.dao.master.IOrganizationDao">

    <resultMap id="BaseResultMap" type="com.startcaft.basic.core.entity.Organization">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="org_name" jdbcType="VARCHAR" property="orgName"/>
        <result column="org_bak" jdbcType="VARCHAR" property="orgBak"/>
        <result column="pid" jdbcType="BIGINT" property="pid"/>
    </resultMap>

    <resultMap type="com.startcaft.basic.core.entity.Organization"
               id="ParentResultMap" extends="BaseResultMap">
        <result column="pid" property="parentOrg.id" jdbcType="BIGINT" />
        <result column="pname" property="parentOrg.orgName" jdbcType="VARCHAR" />
    </resultMap>

    <!-- 递归查询时用到的结果集 -->
    <resultMap id="treeMap" type="com.startcaft.basic.core.entity.Organization" extends="BaseResultMap">
        <collection property="children" column="id" ofType="com.startcaft.basic.core.entity.Organization" select="selectByPid" />
    </resultMap>

    <sql id="Base_Column_List">
      id, org_name, org_bak, pid
    </sql>

    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="ParentResultMap">
        SELECT r1.*,r2.org_name AS pname
        FROM sys_organization r1
        LEFT OUTER  JOIN sys_organization r2
        ON r1.pid = r2.id
        WHERE r1.id = #{id,jdbcType=BIGINT}
    </select>

    <select id="selectListDynamic" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from sys_organization
        <where>
            <if test="name != null and name != ''">
                <bind name="_orgName" value="'%'+name+'%'"/>
                and org_name like #{_orgName}
            </if>
            <if test="pid != null">
                and pid = #{pid}
            </if>
        </where>
    </select>

    <select id="getTree" resultMap="treeMap">
        select * from sys_organization where pid = 0
    </select>

    <select id="selectByPid" resultMap="treeMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        from sys_organization
        WHERE pid = #{_parameter}
        order by id desc
    </select>

    <insert id="insert" parameterType="com.startcaft.basic.core.entity.Organization">
        insert into sys_organization (org_name, org_bak,
          pid)
        values (#{orgName,jdbcType=VARCHAR}, #{orgBak,jdbcType=VARCHAR},
          #{pid,jdbcType=BIGINT})
    </insert>

    <update id="updateByPrimaryKeySelective" parameterType="com.startcaft.basic.core.entity.Organization">
        update sys_organization
        <set>
            <if test="orgName != null">
                org_name = #{orgName,jdbcType=VARCHAR},
            </if>
            <if test="orgBak != null">
                org_bak = #{orgBak,jdbcType=VARCHAR},
            </if>
            <if test="pid != null">
                pid = #{pid,jdbcType=BIGINT},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

</mapper>